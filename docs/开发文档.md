# Python Telegram Bot 开发文档

## 项目架构

### 核心组件

- **telegram_bot.py**: 主要的Telegram机器人实现
- **start_bot.py**: 简化的启动脚本
- **test_python_bot.py**: 单元测试文件
- **requirements.txt**: Python依赖列表
- **.env.example**: 环境配置示例

### 主要类结构

#### TelegramBot 类
```python
class TelegramBot:
    def __init__(self, bot_token, claude_ps1_path, ...)
    def get_updates(self, timeout=30) -> List[Dict]
    def parse_message(self, update) -> Optional[TelegramMessage]
    def call_claude(self, command, timeout=60) -> ClaudeResponse
    def call_claude_streaming(self, command, chat_id, reply_to_message_id, timeout=60) -> bool
    def send_message_plain(self, chat_id, text, reply_to_message_id=None) -> Optional[int]
    def edit_message_plain(self, chat_id, message_id, text) -> bool
    def process_message(self, message) -> bool
```

#### 数据结构
```python
@dataclass
class TelegramMessage:
    message_id: int
    chat_id: int
    text: str
    from_user_id: int
    from_username: str
    date: int

@dataclass
class ClaudeResponse:
    success: bool
    response: str
    error: Optional[str] = None
    duration: Optional[float] = None
```

## 功能特性

### 1. 流式响应处理
- 实时捕获Claude的JSON流式输出
- 每3秒更新一次Telegram消息
- 智能内容清理和格式化

### 2. 消息格式化
- 中英文混合内容优化
- 列表和标题识别
- 代码块保留
- 智能换行处理

### 3. 错误处理
- 网络请求重试机制
- 编码问题自动处理
- 超时保护
- 详细的日志记录

### 4. 安全特性
- 用户ID白名单
- 聊天ID白名单
- 无消息存储
- HTTPS API通信

## 配置说明

### 环境变量
```env
TELEGRAM_BOT_TOKEN=your_bot_token
CLAUDE_CLI_PATH=claude
CLAUDE_WORKING_DIR=/path/to/project
ALLOWED_USER_IDS=123456789,987654321
ALLOWED_CHAT_IDS=-1001234567890
HTTP_PROXY=http://127.0.0.1:7890
POLL_INTERVAL=2
CLAUDE_TIMEOUT=60
LOG_LEVEL=INFO
```

### 命令行参数
```bash
python telegram_bot.py [OPTIONS]

Options:
  --bot-token TOKEN           Telegram Bot Token
  --claude-cli-path PATH      Claude CLI路径
  --claude-working-dir DIR    Claude工作目录
  --proxy URL                 HTTP代理地址
  --poll-interval SECONDS     轮询间隔
  --claude-timeout SECONDS    Claude超时时间
  --log-level LEVEL           日志级别
  --allowed-user-ids IDS      允许的用户ID
  --allowed-chat-ids IDS      允许的聊天ID
```

## Claude CLI 集成

### PowerShell 调用
机器人使用PowerShell调用Claude CLI，支持UTF-8编码：

```python
ps_command = [
    'powershell.exe',
    '-NoProfile',
    '-ExecutionPolicy', 'Bypass',
    '-Command', f'''
        [Console]::OutputEncoding = [Console]::InputEncoding = [System.Text.Encoding]::UTF8;
        cd "{working_dir}"; & "{claude_path}" "{command}" -p --output-format stream-json --verbose
    '''
]
```

### 流式输出解析
实时解析Claude的JSON流式输出：
```json
{"type":"assistant","message":{"content":[{"type":"text","text":"响应内容"}]}}
{"type":"result","subtype":"success","result":"命令完成"}
```

## 部署和运行

### 开发环境
```bash
# 安装依赖
pip install -r requirements.txt

# 配置环境
cp .env.example .env
# 编辑 .env 文件

# 运行测试
python test_python_bot.py

# 启动机器人
python start_bot.py
```

### 生产环境
```bash
# 使用系统服务或进程管理器
# 例如：systemd, supervisor, pm2等

# 建议使用虚拟环境
python -m venv venv
source venv/bin/activate  # Linux/Mac
# 或
venv\Scripts\activate     # Windows

pip install -r requirements.txt
python start_bot.py
```

## 故障排除

### 常见问题

1. **编码问题**
   - 确保系统支持UTF-8
   - 检查PowerShell执行策略
   - 验证Claude CLI路径

2. **网络连接**
   - 配置代理（如需要）
   - 检查Telegram API访问
   - 验证网络连接

3. **权限问题**
   - 确保Claude CLI有执行权限
   - 检查工作目录访问权限
   - 验证用户ID配置

### 调试模式
```bash
# 启用详细日志
python telegram_bot.py --log-level DEBUG

# 或设置环境变量
LOG_LEVEL=DEBUG python start_bot.py
```

## 扩展开发

### 添加新命令
在 `process_message` 方法中添加新的命令处理逻辑：

```python
def process_message(self, message):
    # 现有命令处理...
    
    # 添加新命令
    if message.text.startswith('/custom'):
        return self.handle_custom_command(message)
```

### 自定义消息格式
修改 `_format_response_content` 方法来自定义消息格式：

```python
def _format_response_content(self, content):
    # 自定义格式化逻辑
    return formatted_content
```

### 添加新的API集成
在 `TelegramBot` 类中添加新的方法：

```python
def call_external_api(self, endpoint, data):
    # 调用外部API的逻辑
    pass
```

## 测试

### 运行测试
```bash
python test_python_bot.py
```

### 测试覆盖
- 消息分片功能
- Claude响应提取
- Telegram消息解析
- API连接测试
- 错误处理测试

## 性能优化

### 消息处理
- 使用异步IO提高并发性能
- 实现消息队列处理高并发
- 优化字符串处理和内存使用

### 网络优化
- 实现连接池复用
- 添加请求缓存机制
- 优化重试策略

### 日志优化
- 实现日志轮转
- 添加结构化日志
- 优化日志级别控制